<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URA Proxy è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2196F3;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-ok { background: #4CAF50; color: white; }
        .status-error { background: #f44336; color: white; }
        .status-warning { background: #ff9800; color: white; }
        .button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background: #1976D2; }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .fix-button {
            background: #4CAF50;
            margin-left: 10px;
        }
        .fix-button:hover { background: #45a049; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ URA Proxy è¯Šæ–­å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ“‹ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
            <div id="systemStatus">æ­£åœ¨æ£€æŸ¥...</div>
            <button class="button" onclick="checkSystem()">ğŸ”„ é‡æ–°æ£€æŸ¥</button>
        </div>
        
        <div class="section">
            <h3>âš™ï¸ æ‰©å±•é…ç½®</h3>
            <div id="configStatus">æ­£åœ¨æ£€æŸ¥...</div>
            <button class="button" onclick="checkConfig()">ğŸ”„ æ£€æŸ¥é…ç½®</button>
            <button class="button fix-button" onclick="fixConfig()">ğŸ”§ ä¿®å¤é…ç½®</button>
        </div>
        
        <div class="section">
            <h3>ğŸ¯ æ‹¦æˆªå™¨çŠ¶æ€</h3>
            <div id="interceptorStatus">æ­£åœ¨æ£€æŸ¥...</div>
            <button class="button" onclick="checkInterceptor()">ğŸ”„ æ£€æŸ¥æ‹¦æˆªå™¨</button>
            <button class="button fix-button" onclick="injectInterceptor()">ğŸ’‰ é‡æ–°æ³¨å…¥</button>
        </div>
        
        <div class="section">
            <h3>ğŸ“Š è¯·æ±‚æ—¥å¿—</h3>
            <div id="logsStatus">æ­£åœ¨æ£€æŸ¥...</div>
            <button class="button" onclick="checkLogs()">ğŸ”„ æ£€æŸ¥æ—¥å¿—</button>
            <button class="button" onclick="sendTestRequest()">ğŸ§ª å‘é€æµ‹è¯•è¯·æ±‚</button>
            <button class="button" onclick="openPanel()">ğŸ“‹ æ‰“å¼€é¢æ¿</button>
        </div>
        
        <div class="section">
            <h3>ğŸ› ï¸ å¿«é€Ÿä¿®å¤</h3>
            <p>å¦‚æœä¸Šè¿°æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®è¿›è¡Œä¸€é”®ä¿®å¤ï¼š</p>
            <button class="button fix-button" onclick="quickFix()">ğŸš€ ä¸€é”®ä¿®å¤</button>
            <button class="button" onclick="resetAll()">ğŸ”„ é‡ç½®æ‰€æœ‰é…ç½®</button>
        </div>
        
        <div class="section">
            <h3>ğŸ“ è¯Šæ–­æ—¥å¿—</h3>
            <div id="diagnosticLog" class="log-area">ç­‰å¾…è¯Šæ–­...</div>
            <button class="button" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            <button class="button" onclick="copyLog()">ğŸ“‹ å¤åˆ¶æ—¥å¿—</button>
        </div>
    </div>

    <script>
        let diagnosticMessages = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            diagnosticMessages.push(logMessage);
            
            const logArea = document.getElementById('diagnosticLog');
            logArea.innerHTML = diagnosticMessages.join('\n');
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateStatus(elementId, message, status = 'ok') {
            const element = document.getElementById(elementId);
            const statusClass = `status-${status}`;
            element.innerHTML = `<span class="${statusClass}">${status.toUpperCase()}</span> ${message}`;
        }
        
        async function checkSystem() {
            log('ğŸ” å¼€å§‹ç³»ç»Ÿæ£€æŸ¥...');
            
            // æ£€æŸ¥ Chrome æ‰©å±• API
            const hasExtensionAPI = !!(chrome && chrome.runtime);
            const hasStorageAPI = !!(chrome && chrome.storage);
            const hasScriptingAPI = !!(chrome && chrome.scripting);
            const hasTabsAPI = !!(chrome && chrome.tabs);
            
            if (hasExtensionAPI && hasStorageAPI && hasScriptingAPI && hasTabsAPI) {
                updateStatus('systemStatus', 'æ‰€æœ‰å¿…éœ€çš„ Chrome API å¯ç”¨', 'ok');
                log('âœ… Chrome API æ£€æŸ¥é€šè¿‡');
            } else {
                updateStatus('systemStatus', 'ç¼ºå°‘å¿…éœ€çš„ Chrome API', 'error');
                log('âŒ Chrome API æ£€æŸ¥å¤±è´¥');
                return;
            }
            
            // æ£€æŸ¥æ‰©å±• ID
            try {
                const extensionId = chrome.runtime.id;
                log(`âœ… æ‰©å±• ID: ${extensionId}`);
            } catch (error) {
                log(`âŒ æ— æ³•è·å–æ‰©å±• ID: ${error.message}`);
            }
        }
        
        async function checkConfig() {
            log('ğŸ” æ£€æŸ¥æ‰©å±•é…ç½®...');
            
            try {
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨é…ç½®
                const stored = localStorage.getItem('ura-proxy-intercept-config');
                if (stored) {
                    const config = JSON.parse(stored);
                    if (config.enabled) {
                        updateStatus('configStatus', `æ‹¦æˆªå·²å¯ç”¨ - åŸŸåè¿‡æ»¤: ${config.domainFilter || 'æ— '} - è·¯å¾„è¿‡æ»¤: ${config.pathFilter || 'æ— '}`, 'ok');
                        log('âœ… æœ¬åœ°é…ç½®æ­£å¸¸');
                    } else {
                        updateStatus('configStatus', 'æ‹¦æˆªæœªå¯ç”¨', 'warning');
                        log('âš ï¸ æ‹¦æˆªåŠŸèƒ½æœªå¯ç”¨');
                    }
                } else {
                    updateStatus('configStatus', 'é…ç½®ä¸å­˜åœ¨', 'error');
                    log('âŒ æœªæ‰¾åˆ°é…ç½®');
                }
                
                // æ£€æŸ¥ Chrome å­˜å‚¨
                chrome.storage.local.get(['ura-proxy-intercept-config', 'ura-proxy-request-logs'], (result) => {
                    if (result['ura-proxy-intercept-config']) {
                        log('âœ… Chrome å­˜å‚¨ä¸­æ‰¾åˆ°é…ç½®');
                    } else {
                        log('âš ï¸ Chrome å­˜å‚¨ä¸­æœªæ‰¾åˆ°é…ç½®');
                    }
                    
                    if (result['ura-proxy-request-logs']) {
                        log(`âœ… Chrome å­˜å‚¨ä¸­æ‰¾åˆ° ${result['ura-proxy-request-logs'].length} æ¡æ—¥å¿—`);
                    } else {
                        log('âš ï¸ Chrome å­˜å‚¨ä¸­æœªæ‰¾åˆ°æ—¥å¿—');
                    }
                });
                
            } catch (error) {
                updateStatus('configStatus', `æ£€æŸ¥é…ç½®å¤±è´¥: ${error.message}`, 'error');
                log(`âŒ é…ç½®æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }
        
        async function checkInterceptor() {
            log('ğŸ” æ£€æŸ¥æ‹¦æˆªå™¨çŠ¶æ€...');
            
            try {
                const [tab] = await chrome.tabs.query({active: true, currentWindow: true});
                if (!tab) {
                    updateStatus('interceptorStatus', 'æ— æ³•è·å–å½“å‰æ ‡ç­¾é¡µ', 'error');
                    return;
                }
                
                // æ£€æŸ¥é¡µé¢æ˜¯å¦å¯ä»¥æ³¨å…¥è„šæœ¬
                if (tab.url.startsWith('chrome://') || tab.url.startsWith('chrome-extension://')) {
                    updateStatus('interceptorStatus', 'å½“å‰é¡µé¢ä¸æ”¯æŒè„šæœ¬æ³¨å…¥', 'warning');
                    log('âš ï¸ å½“å‰é¡µé¢æ˜¯ç³»ç»Ÿé¡µé¢ï¼Œæ— æ³•æ³¨å…¥è„šæœ¬');
                    return;
                }
                
                // å°è¯•æ£€æŸ¥æ‹¦æˆªå™¨çŠ¶æ€
                chrome.scripting.executeScript({
                    target: { tabId: tab.id },
                    func: () => {
                        return {
                            hasInterceptor: !!window.uraProxyInterceptorInjected,
                            hasDebug: !!window.uraProxyDebug,
                            url: location.href
                        };
                    }
                }, (results) => {
                    if (results && results[0] && results[0].result) {
                        const result = results[0].result;
                        if (result.hasInterceptor) {
                            updateStatus('interceptorStatus', `æ‹¦æˆªå™¨å·²æ³¨å…¥åˆ°: ${result.url}`, 'ok');
                            log('âœ… æ‹¦æˆªå™¨å·²æ­£ç¡®æ³¨å…¥');
                        } else {
                            updateStatus('interceptorStatus', `æ‹¦æˆªå™¨æœªæ³¨å…¥åˆ°: ${result.url}`, 'warning');
                            log('âš ï¸ æ‹¦æˆªå™¨æœªæ³¨å…¥');
                        }
                    } else {
                        updateStatus('interceptorStatus', 'æ— æ³•æ£€æŸ¥æ‹¦æˆªå™¨çŠ¶æ€', 'error');
                        log('âŒ æ‹¦æˆªå™¨çŠ¶æ€æ£€æŸ¥å¤±è´¥');
                    }
                });
                
            } catch (error) {
                updateStatus('interceptorStatus', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`âŒ æ‹¦æˆªå™¨æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }
        
        async function checkLogs() {
            log('ğŸ” æ£€æŸ¥è¯·æ±‚æ—¥å¿—...');
            
            try {
                // æ£€æŸ¥åå°è„šæœ¬æ—¥å¿—
                chrome.runtime.sendMessage({ type: 'GET_REQUEST_LOGS' }, (response) => {
                    if (response && response.logs) {
                        updateStatus('logsStatus', `åå°è„šæœ¬ä¸­æœ‰ ${response.logs.length} æ¡æ—¥å¿—`, 'ok');
                        log(`âœ… åå°è„šæœ¬æ—¥å¿—: ${response.logs.length} æ¡`);
                    } else {
                        updateStatus('logsStatus', 'åå°è„šæœ¬ä¸­æ— æ—¥å¿—', 'warning');
                        log('âš ï¸ åå°è„šæœ¬ä¸­æ— æ—¥å¿—');
                    }
                });
                
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ—¥å¿—
                chrome.storage.local.get(['ura-proxy-request-logs'], (result) => {
                    if (result['ura-proxy-request-logs']) {
                        log(`âœ… æœ¬åœ°å­˜å‚¨æ—¥å¿—: ${result['ura-proxy-request-logs'].length} æ¡`);
                    } else {
                        log('âš ï¸ æœ¬åœ°å­˜å‚¨ä¸­æ— æ—¥å¿—');
                    }
                });
                
            } catch (error) {
                updateStatus('logsStatus', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`âŒ æ—¥å¿—æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }
        
        async function fixConfig() {
            log('ğŸ”§ å¼€å§‹ä¿®å¤é…ç½®...');
            
            try {
                const config = {
                    enabled: true,
                    domainFilter: '',
                    pathFilter: '',
                    maxRecords: 100
                };
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('ura-proxy-intercept-config', JSON.stringify(config));
                
                // ä¿å­˜åˆ° Chrome å­˜å‚¨
                chrome.storage.local.set({ 'ura-proxy-intercept-config': JSON.stringify(config) });
                
                // é€šçŸ¥åå°è„šæœ¬
                chrome.runtime.sendMessage({
                    type: 'REQUEST_INTERCEPT_CONFIG_CHANGED',
                    config: config
                });
                
                updateStatus('configStatus', 'é…ç½®å·²ä¿®å¤å¹¶å¯ç”¨', 'ok');
                log('âœ… é…ç½®ä¿®å¤å®Œæˆ');
                
            } catch (error) {
                log(`âŒ é…ç½®ä¿®å¤å¤±è´¥: ${error.message}`);
            }
        }
        
        async function injectInterceptor() {
            log('ğŸ’‰ é‡æ–°æ³¨å…¥æ‹¦æˆªå™¨...');
            
            try {
                const [tab] = await chrome.tabs.query({active: true, currentWindow: true});
                if (!tab) {
                    log('âŒ æ— æ³•è·å–å½“å‰æ ‡ç­¾é¡µ');
                    return;
                }
                
                if (tab.url.startsWith('chrome://') || tab.url.startsWith('chrome-extension://')) {
                    log('âš ï¸ å½“å‰é¡µé¢ä¸æ”¯æŒè„šæœ¬æ³¨å…¥');
                    return;
                }
                
                await chrome.scripting.executeScript({
                    target: { tabId: tab.id },
                    files: [],
                    world: 'MAIN'
                });
                
                log('âœ… æ‹¦æˆªå™¨æ³¨å…¥å®Œæˆ');
                
                // ç­‰å¾…ä¸€ç§’åæ£€æŸ¥çŠ¶æ€
                setTimeout(checkInterceptor, 1000);
                
            } catch (error) {
                log(`âŒ æ‹¦æˆªå™¨æ³¨å…¥å¤±è´¥: ${error.message}`);
            }
        }
        
        async function sendTestRequest() {
            log('ğŸ§ª å‘é€æµ‹è¯•è¯·æ±‚...');
            
            try {
                const [tab] = await chrome.tabs.query({active: true, currentWindow: true});
                if (!tab) {
                    log('âŒ æ— æ³•è·å–å½“å‰æ ‡ç­¾é¡µ');
                    return;
                }
                
                chrome.scripting.executeScript({
                    target: { tabId: tab.id },
                    func: () => {
                        fetch('https://httpbin.org/json')
                            .then(() => console.log('ğŸ§ª æµ‹è¯•è¯·æ±‚å®Œæˆ'))
                            .catch(() => console.log('ğŸ§ª æµ‹è¯•è¯·æ±‚å¤±è´¥'));
                    }
                });
                
                log('âœ… æµ‹è¯•è¯·æ±‚å·²å‘é€');
                
            } catch (error) {
                log(`âŒ å‘é€æµ‹è¯•è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
        
        async function openPanel() {
            log('ğŸ“‹ æ‰“å¼€è¯·æ±‚é¢æ¿...');
            
            try {
                const [tab] = await chrome.tabs.query({active: true, currentWindow: true});
                if (!tab) {
                    log('âŒ æ— æ³•è·å–å½“å‰æ ‡ç­¾é¡µ');
                    return;
                }
                
                await chrome.scripting.executeScript({
                    target: { tabId: tab.id },
                    files: ['request-panel.js']
                });
                
                log('âœ… è¯·æ±‚é¢æ¿å·²æ‰“å¼€');
                
            } catch (error) {
                log(`âŒ æ‰“å¼€é¢æ¿å¤±è´¥: ${error.message}`);
            }
        }
        
        async function quickFix() {
            log('ğŸš€ å¼€å§‹ä¸€é”®ä¿®å¤...');
            
            await fixConfig();
            await injectInterceptor();
            
            setTimeout(() => {
                checkSystem();
                checkConfig();
                checkInterceptor();
                checkLogs();
            }, 2000);
            
            log('âœ… ä¸€é”®ä¿®å¤å®Œæˆ');
        }
        
        async function resetAll() {
            log('ğŸ”„ é‡ç½®æ‰€æœ‰é…ç½®...');
            
            try {
                // æ¸…ç©ºæœ¬åœ°å­˜å‚¨
                localStorage.removeItem('ura-proxy-intercept-config');
                localStorage.removeItem('ura-proxy-request-logs');
                localStorage.removeItem('ura-proxy-request-logs-backup');
                
                // æ¸…ç©º Chrome å­˜å‚¨
                chrome.storage.local.clear();
                
                log('âœ… æ‰€æœ‰é…ç½®å·²é‡ç½®');
                
                // é‡æ–°åˆå§‹åŒ–
                setTimeout(quickFix, 1000);
                
            } catch (error) {
                log(`âŒ é‡ç½®å¤±è´¥: ${error.message}`);
            }
        }
        
        function clearLog() {
            diagnosticMessages = [];
            document.getElementById('diagnosticLog').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º';
        }
        
        function copyLog() {
            const logText = diagnosticMessages.join('\n');
            navigator.clipboard.writeText(logText).then(() => {
                log('âœ… æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                log('âŒ å¤åˆ¶å¤±è´¥');
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ”§ URA Proxy è¯Šæ–­å·¥å…·å·²å¯åŠ¨');
            setTimeout(() => {
                checkSystem();
                checkConfig();
                checkInterceptor();
                checkLogs();
            }, 500);
        });
    </script>
</body>
</html>
