<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ ‡ç­¾é¡µåˆ‡æ¢è°ƒè¯•é¡µé¢</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #2196F3;
      border-bottom: 2px solid #2196F3;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 12px 24px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-bottom: none;
      cursor: pointer;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
      margin-right: 2px;
    }
    
    .tab.active {
      background: white;
      color: #2196F3;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .alert {
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      border: 1px solid transparent;
    }
    
    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    
    .alert-info {
      color: #0c5460;
      background-color: #d1ecf1;
      border-color: #bee5eb;
    }
    
    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .rule-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
      position: relative;
    }
    
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover {
      background: #1976D2;
    }
    
    .btn-success {
      background: #4CAF50;
    }
    
    .btn-success:hover {
      background: #45a049;
    }
    
    textarea {
      width: 100%;
      min-height: 200px;
      font-family: 'Courier New', monospace;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      white-space: pre;
      overflow-wrap: normal;
      overflow-x: auto;
    }
    
    #debugOutput {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ› æ ‡ç­¾é¡µåˆ‡æ¢è°ƒè¯•é¡µé¢</h1>
    
    <div id="alertContainer"></div>
    
    <div class="tabs">
      <div class="tab active" id="visualTabBtn">ğŸ“‹ å¯è§†åŒ–ç¼–è¾‘</div>
      <div class="tab" id="jsonTabBtn">ğŸ’» JSONç¼–è¾‘</div>
      <div class="tab" id="helpTabBtn">â“ å¸®åŠ©è¯´æ˜</div>
    </div>
    
    <!-- å¯è§†åŒ–ç¼–è¾‘æ ‡ç­¾é¡µ -->
    <div id="visualTab" class="tab-content active">
      <h2>ğŸ“‹ å¯è§†åŒ–ç¼–è¾‘</h2>
      <div id="rulesStatus" class="alert alert-info" style="display: none;">
        æ­£åœ¨åŠ è½½è§„åˆ™åˆ—è¡¨...
      </div>
      <div id="rulesList">
        <!-- è§„åˆ™åˆ—è¡¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
      </div>
      <button onclick="testRenderRules()">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°è§„åˆ™åˆ—è¡¨</button>
    </div>
    
    <!-- JSONç¼–è¾‘æ ‡ç­¾é¡µ -->
    <div id="jsonTab" class="tab-content">
      <h2>ğŸ’» JSONç¼–è¾‘</h2>
      <textarea id="jsonEditor">
[
  {
    "id": 1,
    "priority": 1,
    "action": {
      "type": "redirect",
      "redirect": {
        "regexSubstitution": "http://localhost:8091\\1"
      }
    },
    "condition": {
      "regexFilter": "^https://your-api-domain\\.com(.*)",
      "resourceTypes": ["xmlhttprequest"]
    }
  }
]
      </textarea>
    </div>
    
    <!-- å¸®åŠ©è¯´æ˜æ ‡ç­¾é¡µ -->
    <div id="helpTab" class="tab-content">
      <h2>â“ å¸®åŠ©è¯´æ˜</h2>
      <div class="alert alert-info">
        <h3>ğŸ§ª è°ƒè¯•æ­¥éª¤</h3>
        <ol>
          <li><strong>åˆå§‹çŠ¶æ€</strong>ï¼šé¡µé¢åŠ è½½æ—¶åº”è¯¥æ˜¾ç¤ºå¯è§†åŒ–ç¼–è¾‘é¡µé¢ï¼Œå¹¶çœ‹åˆ°è§„åˆ™åˆ—è¡¨</li>
          <li><strong>åˆ‡æ¢åˆ°JSON</strong>ï¼šç‚¹å‡»"JSONç¼–è¾‘"æ ‡ç­¾ï¼Œåº”è¯¥çœ‹åˆ°JSONå†…å®¹</li>
          <li><strong>åˆ‡æ¢åˆ°å¸®åŠ©</strong>ï¼šç‚¹å‡»"å¸®åŠ©è¯´æ˜"æ ‡ç­¾ï¼Œåº”è¯¥çœ‹åˆ°æ­¤é¡µé¢</li>
          <li><strong>å›åˆ°å¯è§†åŒ–</strong>ï¼šç‚¹å‡»"å¯è§†åŒ–ç¼–è¾‘"æ ‡ç­¾ï¼Œ<strong>è§„åˆ™åˆ—è¡¨åº”è¯¥é‡æ–°æ˜¾ç¤º</strong></li>
          <li><strong>æ£€æŸ¥è°ƒè¯•æ—¥å¿—</strong>ï¼šåœ¨æµè§ˆå™¨æ§åˆ¶å°å’Œä¸‹æ–¹çš„è°ƒè¯•è¾“å‡ºä¸­æŸ¥çœ‹æ—¥å¿—</li>
        </ol>
      </div>
    </div>
    
    <div id="debugOutput">
      <strong>ğŸ› è°ƒè¯•è¾“å‡º:</strong><br>
      é¡µé¢åŠ è½½ä¸­...
    </div>
  </div>
  
  <script>
    // æ¨¡æ‹Ÿå½“å‰è§„åˆ™æ•°æ®
    let currentRules = [
      {
        "id": 1,
        "priority": 1,
        "action": {
          "type": "redirect",
          "redirect": {
            "regexSubstitution": "http://localhost:8091\\1"
          }
        },
        "condition": {
          "regexFilter": "^https://your-api-domain\\.com(.*)",
          "resourceTypes": ["xmlhttprequest"]
        }
      },
      {
        "id": 2,
        "priority": 1,
        "action": {
          "type": "redirect",
          "redirect": {
            "regexSubstitution": "http://localhost:3000\\1"
          }
        },
        "condition": {
          "regexFilter": "^https://api\\.example\\.com(.*)",
          "resourceTypes": ["xmlhttprequest"]
        }
      }
    ];
    
    // è°ƒè¯•è¾“å‡º
    function debugLog(message) {
      const debugOutput = document.getElementById('debugOutput');
      const timestamp = new Date().toLocaleTimeString();
      debugOutput.innerHTML += `<br>[${timestamp}] ${message}`;
      debugOutput.scrollTop = debugOutput.scrollHeight;
      console.log(`[DEBUG] ${message}`);
    }
    
    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      container.appendChild(alert);
      debugLog(`æ˜¾ç¤ºæç¤º: [${type}] ${message}`);
      
      setTimeout(() => {
        if (alert.parentNode) {
          alert.parentNode.removeChild(alert);
        }
      }, 3000);
    }
    
    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      debugLog(`æ­£åœ¨åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${tabName}`);
      
      // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeçŠ¶æ€
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
      const targetTab = document.getElementById(tabName + 'Tab');
      if (targetTab) {
        targetTab.classList.add('active');
        debugLog(`å·²æ¿€æ´»æ ‡ç­¾é¡µå†…å®¹: ${tabName}Tab`);
      } else {
        debugLog(`âŒ æ‰¾ä¸åˆ°æ ‡ç­¾é¡µå†…å®¹: ${tabName}Tab`);
      }
      
      // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
      let activeTabId = '';
      if (tabName === 'visual') {
        activeTabId = 'visualTabBtn';
      } else if (tabName === 'json') {
        activeTabId = 'jsonTabBtn';
      } else if (tabName === 'help') {
        activeTabId = 'helpTabBtn';
      }
      
      const activeTab = document.getElementById(activeTabId);
      if (activeTab) {
        activeTab.classList.add('active');
        debugLog(`å·²æ¿€æ´»æ ‡ç­¾æŒ‰é’®: ${activeTabId}`);
      } else {
        debugLog(`âŒ æ‰¾ä¸åˆ°æ ‡ç­¾æŒ‰é’®: ${activeTabId}`);
      }
      
      // æ ¹æ®åˆ‡æ¢çš„æ ‡ç­¾é¡µæ‰§è¡Œç›¸åº”çš„åˆå§‹åŒ–
      if (tabName === 'visual') {
        debugLog('æ­£åœ¨é‡æ–°æ¸²æŸ“è§„åˆ™åˆ—è¡¨...');
        renderRulesList();
        showAlert('å·²åˆ‡æ¢åˆ°å¯è§†åŒ–ç¼–è¾‘é¡µé¢ï¼Œè§„åˆ™åˆ—è¡¨å·²åˆ·æ–°', 'success');
      } else if (tabName === 'json') {
        debugLog('æ­£åœ¨åŠ è½½JSONæ•°æ®...');
        loadJsonFromStorage();
        showAlert('å·²åˆ‡æ¢åˆ°JSONç¼–è¾‘é¡µé¢', 'info');
      } else if (tabName === 'help') {
        showAlert('å·²åˆ‡æ¢åˆ°å¸®åŠ©è¯´æ˜é¡µé¢', 'info');
      }
    }
    
    // æ¸²æŸ“è§„åˆ™åˆ—è¡¨
    function renderRulesList() {
      const container = document.getElementById('rulesList');
      const statusContainer = document.getElementById('rulesStatus');
      
      if (!container) {
        debugLog('âŒ æ‰¾ä¸åˆ°rulesListå®¹å™¨');
        return;
      }
      
      debugLog(`å¼€å§‹æ¸²æŸ“è§„åˆ™åˆ—è¡¨ï¼Œå½“å‰è§„åˆ™æ•°é‡: ${currentRules.length}`);
      
      // æ›´æ–°çŠ¶æ€æç¤º
      if (statusContainer) {
        statusContainer.style.display = 'block';
        statusContainer.textContent = `åˆ·æ–°è§„åˆ™åˆ—è¡¨...ï¼ˆå½“å‰ ${currentRules.length} æ¡è§„åˆ™ï¼‰`;
        statusContainer.className = 'alert alert-info';
      }
      
      if (currentRules.length === 0) {
        container.innerHTML = '<div class="alert alert-info">æš‚æ— é‡å®šå‘è§„åˆ™ã€‚</div>';
        if (statusContainer) {
          statusContainer.style.display = 'none';
        }
        debugLog('è§„åˆ™åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
        return;
      }
      
      // æ¨¡æ‹Ÿå¼‚æ­¥æ¸²æŸ“
      setTimeout(() => {
        container.innerHTML = currentRules.map((rule, index) => {
          const regex = rule.condition.regexFilter;
          const target = rule.action.redirect.regexSubstitution;
          
          // ç®€åŒ–æ˜¾ç¤ºæ ¼å¼
          let sourceDisplay = regex.replace(/^\^https?:\\\\\\\\/, 'https://').replace(/\\\\\./g, '.').replace(/\(\.\*\)$/, '*');
          let targetDisplay = target.replace(/\\\\1$/, '*');
          
          return `
            <div class="rule-item">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: bold; color: #2196F3;">è§„åˆ™ ${rule.id}</div>
                <div>
                  <button style="padding: 6px 12px; font-size: 12px; margin: 0 2px;">ç¼–è¾‘</button>
                  <button style="padding: 6px 12px; font-size: 12px; margin: 0 2px; background: #f44336;">åˆ é™¤</button>
                </div>
              </div>
              <div style="font-size: 13px; color: #666;">
                <strong>ä»:</strong> ${sourceDisplay}<br>
                <strong>åˆ°:</strong> ${targetDisplay}<br>
                <strong>ä¼˜å…ˆçº§:</strong> ${rule.priority} | <strong>ç±»å‹:</strong> ${rule.condition.resourceTypes.join(', ')}<br>
                <small>æ¸²æŸ“æ—¶é—´: ${new Date().toLocaleTimeString()}</small>
              </div>
            </div>
          `;
        }).join('');
        
        // æ›´æ–°çŠ¶æ€æç¤ºä¸ºæˆåŠŸ
        if (statusContainer) {
          statusContainer.style.display = 'block';
          statusContainer.textContent = `âœ… è§„åˆ™åˆ—è¡¨å·²æ›´æ–°ï¼å½“å‰å…±æœ‰ ${currentRules.length} æ¡é‡å®šå‘è§„åˆ™`;
          statusContainer.className = 'alert alert-success';
          
          // 3ç§’åéšè—çŠ¶æ€æç¤º
          setTimeout(() => {
            statusContainer.style.display = 'none';
          }, 3000);
        }
        
        debugLog(`âœ… è§„åˆ™åˆ—è¡¨æ¸²æŸ“å®Œæˆï¼Œå…±${currentRules.length}æ¡è§„åˆ™`);
      }, 300);
    }
    
    // åŠ è½½JSONæ•°æ®
    function loadJsonFromStorage() {
      const jsonEditor = document.getElementById('jsonEditor');
      if (jsonEditor) {
        jsonEditor.value = JSON.stringify(currentRules, null, 2);
        debugLog('JSONæ•°æ®å·²åŠ è½½åˆ°ç¼–è¾‘å™¨');
      }
    }
    
    // æ‰‹åŠ¨æµ‹è¯•æ¸²æŸ“è§„åˆ™
    function testRenderRules() {
      debugLog('æ‰‹åŠ¨è§¦å‘è§„åˆ™åˆ—è¡¨æ¸²æŸ“');
      renderRulesList();
    }
    
    // é¡µé¢åŠ è½½å®Œæˆæ—¶è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('é¡µé¢DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
      
      // è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
      const visualTabBtn = document.getElementById('visualTabBtn');
      const jsonTabBtn = document.getElementById('jsonTabBtn');
      const helpTabBtn = document.getElementById('helpTabBtn');
      
      if (visualTabBtn) {
        visualTabBtn.addEventListener('click', () => switchTab('visual'));
        debugLog('å¯è§†åŒ–æ ‡ç­¾æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
      } else {
        debugLog('âŒ æ‰¾ä¸åˆ°å¯è§†åŒ–æ ‡ç­¾æŒ‰é’®');
      }
      
      if (jsonTabBtn) {
        jsonTabBtn.addEventListener('click', () => switchTab('json'));
        debugLog('JSONæ ‡ç­¾æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
      } else {
        debugLog('âŒ æ‰¾ä¸åˆ°JSONæ ‡ç­¾æŒ‰é’®');
      }
      
      if (helpTabBtn) {
        helpTabBtn.addEventListener('click', () => switchTab('help'));
        debugLog('å¸®åŠ©æ ‡ç­¾æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
      } else {
        debugLog('âŒ æ‰¾ä¸åˆ°å¸®åŠ©æ ‡ç­¾æŒ‰é’®');
      }
      
      // åˆå§‹æ¸²æŸ“
      debugLog('å¼€å§‹åˆå§‹æ¸²æŸ“...');
      renderRulesList();
      loadJsonFromStorage();
      
      showAlert('ğŸ§ª è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆï¼å¯ä»¥å¼€å§‹æµ‹è¯•æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½', 'success');
      debugLog('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    });
  </script>
</body>
</html>
