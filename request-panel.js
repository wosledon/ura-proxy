// request-panel.js - Ê≥®ÂÖ•Âà∞ÁΩëÈ°µÂè≥‰æßÁöÑÂÆûÊó∂ËØ∑Ê±ÇÊó•ÂøóÈù¢Êùø
(function() {
  if (window.__URA_PROXY_PANEL__) return; // Èò≤Ê≠¢ÈáçÂ§çÊ≥®ÂÖ•
  window.__URA_PROXY_PANEL__ = true;

  // ‰øÆÊîπÈ°µÈù¢Â∏ÉÂ±Ä‰ª•ÈÄÇÂ∫îÈù¢Êùø
  function adjustPageLayout(show) {
    const body = document.body;
    const html = document.documentElement;
    
    if (show) {
      // ‰∏∫È°µÈù¢Ê∑ªÂä†Âè≥‰æßËæπË∑ùÔºåÁªôÈù¢ÊùøËÖæÂá∫Á©∫Èó¥
      body.style.marginRight = '420px';
      body.style.transition = 'margin-right 0.3s ease';
      html.style.transition = 'margin-right 0.3s ease';
    } else {
      // ÊÅ¢Â§çÈ°µÈù¢Â∏ÉÂ±Ä
      body.style.marginRight = '0';
      setTimeout(() => {
        body.style.transition = '';
        html.style.transition = '';
      }, 300);
    }
  }

  // Ë∞ÉÊï¥È°µÈù¢Â∏ÉÂ±Ä
  adjustPageLayout(true);

  // ÂàõÂª∫ Shadow DOM ÂÆπÂô®
  const panelHost = document.createElement('div');
  panelHost.style.position = 'fixed';
  panelHost.style.top = '0';
  panelHost.style.right = '0';
  panelHost.style.zIndex = '2147483647';
  panelHost.style.width = '420px';
  panelHost.style.height = '100vh';
  panelHost.style.pointerEvents = 'none';
  panelHost.style.transition = 'right 0.3s ease';
  document.body.appendChild(panelHost);

  const shadow = panelHost.attachShadow({mode: 'open'});

  // Ê†∑Âºè
  const style = document.createElement('style');
  style.textContent = `
    .ura-proxy-panel {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      background: #fff;
      border-left: 1px solid #e0e0e0;
      box-shadow: -2px 0 12px rgba(0,0,0,0.08);
      width: 400px;
      height: 100vh;
      position: fixed;
      right: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      pointer-events: auto;
      transition: right 0.3s ease;
    }
    .ura-proxy-panel-header {
      background: #2196F3;
      color: #fff;
      padding: 10px 16px;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: move;
      user-select: none;
    }
    .ura-proxy-panel-toggle {
      background: none;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      margin-left: 8px;
    }
    .ura-proxy-panel-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      margin-left: 8px;
    }
    .ura-proxy-panel-body {
      flex: 1;
      overflow-y: auto;
      background: #fafbfc;
      padding: 0 0 10px 0;
    }
    .ura-proxy-panel-search {
      padding: 8px 16px 0 16px;
      background: #fafbfc;
      border-bottom: 1px solid #eee;
    }
    .ura-proxy-panel-search input {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    .ura-proxy-panel-loglist {
      padding: 0 16px;
    }
    .ura-proxy-panel-logitem {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      margin: 10px 0 0 0;
      padding: 10px;
      font-size: 13px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .ura-proxy-panel-logitem .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .ura-proxy-panel-logitem .log-status {
      border-radius: 3px;
      padding: 1px 6px;
      font-size: 11px;
      margin-right: 6px;
    }
    .ura-proxy-panel-logitem .log-status-success {
      background: #4CAF50;
      color: #fff;
    }
    .ura-proxy-panel-logitem .log-status-warning {
      background: #ff9800;
      color: #fff;
    }
    .ura-proxy-panel-logitem .log-status-danger {
      background: #f44336;
      color: #fff;
    }
    .ura-proxy-panel-logitem .log-url {
      font-size: 12px;
      color: #666;
      word-break: break-all;
    }
    .ura-proxy-panel-logitem .log-actions {
      display: flex;
      gap: 4px;
    }
    .ura-proxy-panel-logitem .log-actions button {
      background: #2196F3;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 11px;
    }
    .ura-proxy-panel-logitem .log-actions button:hover {
      background: #1976D2;
    }
    .ura-proxy-panel-logitem .log-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .ura-proxy-panel-logitem .log-status {
      border-radius: 3px;
      padding: 1px 6px;
      font-size: 11px;
      margin-right: 6px;
      color: #fff;
    }
    .ura-proxy-panel-logitem .log-status-success { background: #4CAF50; }
    .ura-proxy-panel-logitem .log-status-danger { background: #f44336; }
    .ura-proxy-panel-logitem .log-status-warning { background: #ff9800; }
    .ura-proxy-panel-logitem .log-url {
      word-break: break-all;
      color: #333;
      flex: 1;
    }
    .ura-proxy-panel-logitem .log-actions button {
      background: #eee;
      border: none;
      border-radius: 3px;
      padding: 2px 8px;
      margin-left: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .ura-proxy-panel-logitem .log-details {
      margin-top: 8px;
      background: #f8f9fa;
      border-radius: 4px;
      padding: 8px;
      font-size: 12px;
      display: none;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .ura-proxy-panel-footer {
      padding: 8px 16px;
      background: #fafbfc;
      border-top: 1px solid #eee;
      font-size: 12px;
      color: #888;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ura-proxy-panel-footer button {
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 12px;
    }
    .ura-proxy-panel-collapsed {
      right: -380px !important;
    }
    .ura-proxy-panel-footer {
      background: #f8f9fa;
      border-top: 1px solid #eee;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .ura-proxy-panel-footer button {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 12px;
    }
    .ura-proxy-panel-empty {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 14px;
    }
  `;
  shadow.appendChild(style);

  // ‰∏ªÈù¢ÊùøÁªìÊûÑ
  const panel = document.createElement('div');
  panel.className = 'ura-proxy-panel';
  panel.innerHTML = `
    <div class="ura-proxy-panel-header">
      <span>URA Proxy ËØ∑Ê±ÇÈù¢Êùø</span>
      <span>
        <button class="ura-proxy-panel-toggle" title="Êî∂Ëµ∑/Â±ïÂºÄ">¬ª</button>
        <button class="ura-proxy-panel-close" title="ÂÖ≥Èó≠Èù¢Êùø">√ó</button>
      </span>
    </div>
    <div class="ura-proxy-panel-search">
      <input type="text" placeholder="ÊêúÁ¥¢URL/ÂÜÖÂÆπ..." />
    </div>
    <div class="ura-proxy-panel-body">
      <div class="ura-proxy-panel-loglist"></div>
    </div>
    <div class="ura-proxy-panel-footer">
      <span class="ura-proxy-panel-count">Êó•Âøó: 0</span>
      <button class="ura-proxy-panel-clear">Ê∏ÖÁ©∫Êó•Âøó</button>
    </div>
  `;
  shadow.appendChild(panel);

  // ÊãñÊãΩÊî∂Ëµ∑/Â±ïÂºÄ
  const toggleBtn = panel.querySelector('.ura-proxy-panel-toggle');
  const closeBtn = panel.querySelector('.ura-proxy-panel-close');
  let collapsed = false;
  
  toggleBtn.onclick = function() {
    collapsed = !collapsed;
    if (collapsed) {
      panelHost.classList.add('ura-proxy-panel-collapsed');
      toggleBtn.textContent = '¬´';
      adjustPageLayout(false);
    } else {
      panelHost.classList.remove('ura-proxy-panel-collapsed');
      toggleBtn.textContent = '¬ª';
      adjustPageLayout(true);
    }
  };

  // ÂÖ≥Èó≠Èù¢Êùø
  closeBtn.onclick = function() {
    adjustPageLayout(false);
    clearInterval(refreshInterval);
    panelHost.remove();
    window.__URA_PROXY_PANEL__ = false;
  };

  // ÊãñÊãΩÈù¢ÊùøÔºà‰ªÖ‰∏ä‰∏ãÔºâ
  let isDragging = false, dragStartY = 0, dragStartTop = 0;
  const header = panel.querySelector('.ura-proxy-panel-header');
  header.addEventListener('mousedown', function(e) {
    isDragging = true;
    dragStartY = e.clientY;
    dragStartTop = panelHost.offsetTop;
    document.body.style.userSelect = 'none';
  });
  window.addEventListener('mousemove', function(e) {
    if (isDragging) {
      let newTop = dragStartTop + (e.clientY - dragStartY);
      newTop = Math.max(0, Math.min(window.innerHeight - 100, newTop));
      panelHost.style.top = newTop + 'px';
    }
  });
  window.addEventListener('mouseup', function() {
    isDragging = false;
    document.body.style.userSelect = '';
  });

  // Êó•ÂøóÊ∏≤Êüì‰∏é‰∫§‰∫í
  const logList = panel.querySelector('.ura-proxy-panel-loglist');
  const searchInput = panel.querySelector('.ura-proxy-panel-search input');
  const countSpan = panel.querySelector('.ura-proxy-panel-count');
  const clearBtn = panel.querySelector('.ura-proxy-panel-clear');

  let logs = [];
  let searchTerm = '';

  function renderLogs() {
    let filtered = logs;
    if (searchTerm) {
      filtered = logs.filter(log =>
        log.url.toLowerCase().includes(searchTerm) ||
        log.method.toLowerCase().includes(searchTerm) ||
        (log.requestBody && log.requestBody.toLowerCase().includes(searchTerm)) ||
        (log.responseBody && log.responseBody.toLowerCase().includes(searchTerm))
      );
    }
    
    countSpan.textContent = `Êó•Âøó: ${filtered.length}`;
    
    if (filtered.length === 0) {
      logList.innerHTML = `
        <div class="ura-proxy-panel-empty">
          üìã ÊöÇÊó†ËØ∑Ê±ÇÊó•Âøó<br>
          <small>ÂêØÁî®Êã¶Êà™ÂäüËÉΩÂêéÔºåÁ¨¶ÂêàÊù°‰ª∂ÁöÑËØ∑Ê±ÇÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå</small>
        </div>
      `;
      return;
    }
    
    logList.innerHTML = filtered.map((log, idx) => {
      const statusClass = log.status >= 200 && log.status < 300 ? 'log-status-success' :
        log.status >= 400 ? 'log-status-danger' : 'log-status-warning';
      const timestamp = new Date(log.timestamp).toLocaleString();
      const urlDisplay = log.url.length > 50 ? log.url.substring(0, 50) + '...' : log.url;
      
      return `
        <div class="ura-proxy-panel-logitem">
          <div class="log-header">
            <div style="flex: 1; overflow: hidden;">
              <span class="log-method">${log.method}</span>
              <span class="log-status ${statusClass}">${log.status}</span>
              <div class="log-url" title="${log.url}">${urlDisplay}</div>
              <div style="font-size: 11px; color: #666; margin-top: 2px;">${timestamp}</div>
            </div>
            <div class="log-actions">
              <button data-idx="${idx}" class="log-copy">üìã</button>
              <button data-idx="${idx}" class="log-toggle">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="log-details" id="ura-proxy-log-details-${idx}" style="display: none;">
            <div style="margin: 8px 0;"><strong>URL:</strong> ${log.url}</div>
            <div style="margin: 8px 0;"><strong>Content-Type:</strong> ${log.contentType || 'Êú™Áü•'}</div>
            <div style="margin: 8px 0;"><strong>ËØ∑Ê±Ç‰Ωì:</strong><pre style="background: #f5f5f5; padding: 8px; border-radius: 3px; white-space: pre-wrap; font-size: 11px; max-height: 100px; overflow-y: auto;">${log.requestBody || 'Êó†'}</pre></div>
            <div style="margin: 8px 0;"><strong>ÂìçÂ∫î‰Ωì:</strong><pre style="background: #f5f5f5; padding: 8px; border-radius: 3px; white-space: pre-wrap; font-size: 11px; max-height: 150px; overflow-y: auto;">${log.responseBody || 'Êó†'}</pre></div>
          </div>
        </div>
      `;
    }).join('');
    
    // ÁªëÂÆö‰∫ã‰ª∂
    logList.querySelectorAll('.log-copy').forEach(btn => {
      btn.onclick = function() {
        const idx = parseInt(btn.getAttribute('data-idx'));
        const log = filtered[idx];
        const text = `=== HTTP ËØ∑Ê±ÇÊó•Âøó ===\nÊó∂Èó¥: ${new Date(log.timestamp).toLocaleString()}\nÊñπÊ≥ï: ${log.method}\nÁä∂ÊÄÅ: ${log.status}\nURL: ${log.url}\nContent-Type: ${log.contentType || 'Êú™Áü•'}\n\n=== ËØ∑Ê±ÇÂ§¥ ===\n${JSON.stringify(log.requestHeaders || {}, null, 2)}\n\n=== ËØ∑Ê±Ç‰Ωì ===\n${log.requestBody || 'Êó†'}\n\n=== ÂìçÂ∫îÂ§¥ ===\n${JSON.stringify(log.responseHeaders || {}, null, 2)}\n\n=== ÂìçÂ∫î‰Ωì ===\n${log.responseBody || 'Êó†'}`;
        navigator.clipboard.writeText(text).then(() => {
          btn.textContent = '‚úÖ';
          setTimeout(() => btn.textContent = 'üìã', 1000);
        });
      };
    });
    
    logList.querySelectorAll('.log-toggle').forEach(btn => {
      btn.onclick = function() {
        const idx = btn.getAttribute('data-idx');
        const details = logList.querySelector(`#ura-proxy-log-details-${idx}`);
        if (details) {
          const isVisible = details.style.display !== 'none';
          details.style.display = isVisible ? 'none' : 'block';
          btn.textContent = isVisible ? 'üëÅÔ∏è' : 'üôà';
        }
      };
    });
  }

  searchInput.addEventListener('input', function() {
    searchTerm = searchInput.value.trim().toLowerCase();
    renderLogs();
  });

  clearBtn.onclick = function() {
    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËØ∑Ê±ÇÊó•ÂøóÂêóÔºü')) {
      logs = [];
      renderLogs();
      chrome.runtime.sendMessage({ type: 'CLEAR_REQUEST_LOGS' }).catch(() => {
        console.warn('Ê∏ÖÁ©∫Êó•ÂøóÊ∂àÊÅØÂèëÈÄÅÂ§±Ë¥•');
      });
    }
  };

  // ‰ªéÂ§ö‰∏™Ê∫êËé∑ÂèñÊó•ÂøóÊï∞ÊçÆ
  function fetchLogs() {
    // Â∞ùËØï‰ªé background script Ëé∑Âèñ
    chrome.runtime.sendMessage({ type: 'GET_REQUEST_LOGS' }).then(resp => {
      if (resp && Array.isArray(resp.logs)) {
        logs = resp.logs;
        renderLogs();
        console.log('üìã ‰ªéÂêéÂè∞ËÑöÊú¨Ëé∑ÂèñÊó•Âøó:', logs.length, 'Êù°');
        return;
      }
      // Â¶ÇÊûú background script Ê≤°ÊúâËøîÂõûÔºåÂ∞ùËØï‰ªéÊú¨Âú∞Â≠òÂÇ®Ëé∑Âèñ
      return fetchLogsFromStorage();
    }).catch((error) => {
      console.warn('‰ªéÂêéÂè∞ËÑöÊú¨Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•:', error);
      // Â¶ÇÊûúÊ∂àÊÅØÂèëÈÄÅÂ§±Ë¥•Ôºå‰ªéÊú¨Âú∞Â≠òÂÇ®Ëé∑Âèñ
      fetchLogsFromStorage();
    });
  }

  // ‰ªéÊú¨Âú∞Â≠òÂÇ®Ëé∑ÂèñÊó•Âøó
  function fetchLogsFromStorage() {
    try {
      chrome.storage.local.get(['ura-proxy-request-logs']).then(result => {
        if (result['ura-proxy-request-logs']) {
          logs = result['ura-proxy-request-logs'];
          renderLogs();
          console.log('üìã ‰ªéÊú¨Âú∞Â≠òÂÇ®Ëé∑ÂèñÊó•Âøó:', logs.length, 'Êù°');
        } else {
          // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
          logs = [];
          renderLogs();
          console.log('üìã Êó†Êó•ÂøóÊï∞ÊçÆ');
        }
      }).catch(() => {
        // ÂÖºÂÆπÊÄßÔºöÂ∞ùËØï‰ªé localStorage Ëé∑Âèñ
        const stored = localStorage.getItem('ura-proxy-request-logs');
        if (stored) {
          logs = JSON.parse(stored);
          renderLogs();
          console.log('üìã ‰ªélocalStorageËé∑ÂèñÊó•Âøó:', logs.length, 'Êù°');
        } else {
          logs = [];
          renderLogs();
          console.log('üìã Êó†Êó•ÂøóÊï∞ÊçÆ');
        }
      });
    } catch (error) {
      console.error('‰ªéÊú¨Âú∞Â≠òÂÇ®Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•:', error);
      logs = [];
      renderLogs();
    }
  }

  // ÂàùÂßãËé∑ÂèñÊó•Âøó
  fetchLogs();
  
  // ÂÆöÊó∂Âà∑Êñ∞Êó•Âøó
  const refreshInterval = setInterval(fetchLogs, 3000);

  // ÊîØÊåÅ background Êé®ÈÄÅÊñ∞Êó•Âøó
  chrome.runtime.onMessage.addListener((msg) => {
    if (msg.type === 'NEW_REQUEST_LOG') {
      logs.unshift(msg.log);
      if (logs.length > 200) logs = logs.slice(0, 200);
      renderLogs();
    }
  });

  // ÊîØÊåÅ ESC Âø´Êç∑ÈîÆÊî∂Ëµ∑/Â±ïÂºÄ
  window.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') toggleBtn.click();
  });
})();
