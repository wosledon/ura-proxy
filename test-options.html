<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>APIé‡å®šå‘é…ç½®ç®¡ç† - æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #2196F3;
      border-bottom: 2px solid #2196F3;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }
    
    .alert {
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      border: 1px solid transparent;
    }
    
    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    
    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .alert-info {
      color: #0c5460;
      background-color: #d1ecf1;
      border-color: #bee5eb;
    }
    
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    button:hover {
      background: #1976D2;
    }
    
    .btn-success {
      background: #4CAF50;
    }
    
    .btn-success:hover {
      background: #45a049;
    }
    
    .btn-danger {
      background: #f44336;
    }
    
    .btn-danger:hover {
      background: #da190b;
    }
    
    input {
      width: 200px;
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ é…ç½®åŠŸèƒ½æµ‹è¯•</h1>
    
    <div id="alertContainer"></div>
    
    <h2>æµ‹è¯•åŠŸèƒ½</h2>
    <button id="testAlertBtn">æµ‹è¯•æç¤º</button>
    <button id="testLocalStorageBtn">æµ‹è¯•æœ¬åœ°å­˜å‚¨</button>
    <button id="testLoadRulesBtn">æµ‹è¯•åŠ è½½è§„åˆ™</button>
    
    <h2>å¿«é€Ÿæ·»åŠ è§„åˆ™æµ‹è¯•</h2>
    <input type="text" id="quickDomain" placeholder="api.example.com" value="test.api.com">
    <input type="text" id="quickPath" placeholder="/api/v1" value="/test">
    <input type="number" id="quickPort" placeholder="3000" value="8080">
    <button id="addQuickRuleBtn" class="btn-success">æ·»åŠ è§„åˆ™</button>
    
    <h2>å½“å‰è§„åˆ™</h2>
    <div id="rulesList"></div>
    
    <button id="clearAllRulesBtn" class="btn-danger">æ¸…ç©ºè§„åˆ™</button>
  </div>
  
  <script>
    // ç®€åŒ–ç‰ˆçš„æµ‹è¯•è„šæœ¬
    let currentRules = [];

    // æµ‹è¯•å‡½æ•°
    function testAlert() {
      showAlert('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æç¤ºï¼', 'success');
    }

    function testLocalStorage() {
      try {
        localStorage.setItem('test-key', 'test-value');
        const value = localStorage.getItem('test-key');
        showAlert('æœ¬åœ°å­˜å‚¨æµ‹è¯•æˆåŠŸ: ' + value, 'success');
        localStorage.removeItem('test-key');
      } catch (error) {
        showAlert('æœ¬åœ°å­˜å‚¨æµ‹è¯•å¤±è´¥: ' + error.message, 'danger');
      }
    }

    function testLoadRules() {
      loadRulesFromStorage();
      showAlert('è§„åˆ™åŠ è½½å®Œæˆï¼Œå½“å‰æœ‰ ' + currentRules.length + ' æ¡è§„åˆ™', 'info');
      renderRulesList();
    }

    // ä»options.jså¤åˆ¶çš„æ ¸å¿ƒå‡½æ•°
    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alertContainer');
      if (!alertContainer) {
        console.error('Alert container not found!');
        console.log(message);
        return;
      }
      
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = message;
      
      alertContainer.appendChild(alertDiv);
      
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.parentNode.removeChild(alertDiv);
        }
      }, 3000);
    }

    function getDefaultRules() {
      return [
        {
          "id": 1,
          "priority": 1,
          "action": {
            "type": "redirect",
            "redirect": {
              "regexSubstitution": "http://localhost:8091\\1"
            }
          },
          "condition": {
            "regexFilter": "^https://centerapi\\.test\\.shijizhongyun\\.com/financeApi(.*)",
            "resourceTypes": ["xmlhttprequest"]
          }
        }
      ];
    }

    function loadRulesFromStorage() {
      try {
        const storedRules = localStorage.getItem('ura-proxy-rules');
        if (storedRules) {
          currentRules = JSON.parse(storedRules);
        } else {
          currentRules = getDefaultRules();
          saveRulesToStorage();
        }
      } catch (error) {
        console.error('åŠ è½½è§„åˆ™å¤±è´¥:', error);
        showAlert('åŠ è½½è§„åˆ™å¤±è´¥: ' + error.message, 'danger');
        currentRules = getDefaultRules();
      }
    }

    function saveRulesToStorage() {
      try {
        localStorage.setItem('ura-proxy-rules', JSON.stringify(currentRules, null, 2));
        showAlert('è§„åˆ™å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼', 'success');
      } catch (error) {
        console.error('ä¿å­˜è§„åˆ™å¤±è´¥:', error);
        showAlert('ä¿å­˜è§„åˆ™å¤±è´¥: ' + error.message, 'danger');
      }
    }

    function renderRulesList() {
      const container = document.getElementById('rulesList');
      if (currentRules.length === 0) {
        container.innerHTML = '<div class="alert alert-info">æš‚æ— é‡å®šå‘è§„åˆ™ã€‚</div>';
        return;
      }
      
      container.innerHTML = currentRules.map((rule, index) => {
        return `
          <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;">
            <strong>è§„åˆ™ ${rule.id}:</strong><br>
            æ­£åˆ™: ${rule.condition.regexFilter}<br>
            ç›®æ ‡: ${rule.action.redirect.regexSubstitution}<br>
            <button class="btn-danger delete-rule-btn" data-index="${index}">åˆ é™¤</button>
          </div>
        `;
      }).join('');
    }

    function addQuickRule() {
      try {
        const domain = document.getElementById('quickDomain').value.trim();
        const path = document.getElementById('quickPath').value.trim();
        const port = document.getElementById('quickPort').value.trim();
        
        if (!domain || !port) {
          showAlert('è¯·å¡«å†™åŸŸåå’Œç«¯å£å·', 'danger');
          return;
        }
        
        const newId = Math.max(...currentRules.map(r => r.id), 0) + 1;
        const escapedDomain = domain.replace(/\./g, '\\\\.');
        const pathPart = path ? path.replace(/\//g, '\\/') : '';
        const regexFilter = `^https://${escapedDomain}${pathPart}(.*)`;
        const regexSubstitution = `http://localhost:${port}\\1`;
        
        const newRule = {
          "id": newId,
          "priority": 1,
          "action": {
            "type": "redirect",
            "redirect": {
              "regexSubstitution": regexSubstitution
            }
          },
          "condition": {
            "regexFilter": regexFilter,
            "resourceTypes": ["xmlhttprequest"]
          }
        };
        
        currentRules.push(newRule);
        renderRulesList();
        saveRulesToStorage();
        
        showAlert(`æ–°è§„åˆ™å·²æ·»åŠ ï¼š${domain}${path} â†’ localhost:${port}`, 'success');
      } catch (error) {
        showAlert('æ·»åŠ è§„åˆ™å¤±è´¥: ' + error.message, 'danger');
        console.error('Add rule error:', error);
      }
    }

    function deleteRule(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§„åˆ™å—ï¼Ÿ')) {
        currentRules.splice(index, 1);
        renderRulesList();
        saveRulesToStorage();
        showAlert('è§„åˆ™å·²åˆ é™¤', 'success');
      }
    }

    function clearAllRules() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è§„åˆ™å—ï¼Ÿ')) {
        currentRules = [];
        renderRulesList();
        saveRulesToStorage();
        showAlert('æ‰€æœ‰è§„åˆ™å·²æ¸…ç©º', 'success');
      }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      try {
        loadRulesFromStorage();
        renderRulesList();
        setupEventListeners();
        showAlert('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆï¼', 'success');
      } catch (error) {
        showAlert('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'danger');
        console.error('Page initialization error:', error);
      }
    });

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // æµ‹è¯•æŒ‰é’®
      document.getElementById('testAlertBtn').addEventListener('click', testAlert);
      document.getElementById('testLocalStorageBtn').addEventListener('click', testLocalStorage);
      document.getElementById('testLoadRulesBtn').addEventListener('click', testLoadRules);
      
      // æ·»åŠ è§„åˆ™æŒ‰é’®
      document.getElementById('addQuickRuleBtn').addEventListener('click', addQuickRule);
      
      // æ¸…ç©ºè§„åˆ™æŒ‰é’®
      document.getElementById('clearAllRulesBtn').addEventListener('click', clearAllRules);
      
      // åˆ é™¤è§„åˆ™æŒ‰é’®äº‹ä»¶å§”æ‰˜
      document.getElementById('rulesList').addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-rule-btn')) {
          const index = parseInt(event.target.dataset.index);
          deleteRule(index);
        }
      });
    }
  </script>
</body>
</html>
